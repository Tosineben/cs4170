<!DOCTYPE html>
<html lang="en">
    
    <head>
        <meta charset="utf-8">
        <title>Image Browser</title>
        <meta name="description" content="Awesome image browsing site" />
        <meta name="author" content="Alden Quimby">

        <!-- stylesheets -->
        <link type="text/css" rel="stylesheet" href="styles/bootstrap/bootstrap.min.css" />
        <link type="text/css" rel="stylesheet" href="styles/bootstrap/bootstrap-responsive.min.css" />
        <link type="text/css" rel="stylesheet" href="styles/imagebrowser.css" />
        <style>

        </style>

        <script type="text/javascript" src="scripts/jquery/jquery-1.8.1.min.js"></script>
        <script type="text/javascript" src="scripts/mustache/mustache.js"></script>
        <script type="text/javascript" src="scripts/mustache/jquery-Mustache.js"></script>
        <script type="text/javascript" src="scripts/bootstrap/bootstrap.min.js"></script>
        <script type="text/javascript" src="scripts/pixastic/pixastic.custom.js"></script>
        <script type="text/javascript" src="scripts/dollar/pdollar.js"></script>
        <script type="text/javascript" src="scripts/imagebrowser-gestures.js"></script>
        <script type="text/javascript" src="scripts/imagebrowser-pixastic.js"></script>
        <script type="text/javascript" src="scripts/imagebrowser.js"></script>
        <script type="text/javascript">

            var _isMouseDown, _points, _dollar, _ctx, _canvasRect;

            function getCanvasRect(canvas) {
                var w = canvas.width;
                var h = canvas.height;

                var cx = canvas.offsetLeft;
                var cy = canvas.offsetTop;
                while (canvas.offsetParent != null) {
                    canvas = canvas.offsetParent;
                    cx += canvas.offsetLeft;
                    cy += canvas.offsetTop;
                }
                return {x: cx, y: cy, width: w, height: h};
            }

            function mouseDownEvent(x, y) {
                enableDragSelect(false);
                _isMouseDown = true;
                x -= _canvasRect.x;
                y -= _canvasRect.y - getScrollY();
                if (_points.length > 0) {
                    _ctx.clearRect(0, 0, _canvasRect.width, _canvasRect.height);                
                }
                _points.length = 1;
                _points[0] = new Point(x, y);
                drawText("Recording unistroke...");
                _ctx.fillRect(x - 4, y - 3, 9, 9);
            }

            function mouseMoveEvent(x, y) {
                if (_isMouseDown) {
                    x -= _canvasRect.x;
                    y -= _canvasRect.y - getScrollY();
                    _points[_points.length] = new Point(x, y, 1); // always just 1 stroke
                    drawConnectedPoint(_points.length - 2, _points.length - 1);

                    // try to handle issue where gesture keeps recording if
                    // user goes outside canvas
                    if (x <= 0 || x >= _canvasRect.width || y <= 0 || y >= _canvasRect.height) {
                        mouseUpEvent();
                    }

                }
            }

            // returns {"No match", 0} if it doesn't match anything
            function mouseUpEvent(x, y) {
                enableDragSelect(true);
                if (_isMouseDown) {
                    _isMouseDown = false;
                    if (_points.length >= 10) {
                        var result = _dollar.Recognize(_points);
                        result = handleOrientation(result);
                        drawText("Result: " + result.Name + " (" + result.Score + ").");
                    } 
                    else {
                        drawText("Too few points made. Please try again.");
                    }
                }
            }

            function handleOrientation(result) {
                if (result.Name == "line") {
                    var leftToRight = _points[_points.length - 1].X - _points[0].X > 0;
                    if (leftToRight) {
                        result.Name = "left to right line";
                    }
                    else { 
                        result.Name = "right to left line";
                    }
                }
                else if (result.Name == "line-vert") {
                    var topToBottom = _points[_points.length - 1].Y - _points[0].Y > 0;
                    if (topToBottom) {
                        result.Name = "top to bottom line";
                    }
                    else { 
                        result.Name = "bottom to top line";
                    }
                }
                return result;
            }

            function drawConnectedPoint(from, to) {
                drawLine(_points[from], _points[to]);
            }

            function drawLine(pt1, pt2) {
                _ctx.beginPath();
                _ctx.moveTo(pt1.X, pt1.Y);
                _ctx.lineTo(pt2.X, pt2.Y);
                _ctx.closePath();
                _ctx.stroke();    
            }

            function enableDragSelect(enable) {
                document.onselectstart = function() { return enable; } 
                document.onmousedown = function() { return enable; }             
            }        

            function getScrollY() {
                return typeof(window.pageYOffset) != 'undefined' ? window.pageYOffset : 0;
            }

            function drawText(str) {
                $('#alertContainer').html(str);
            }

            function drawImageGesture(ptArray) {
                for (var i = 0; i < ptArray.length - 1; i++) {
                    drawLine(ptArray[i], ptArray[i+1]);
                }
            }

            function addImageGestures() {
                for (var i = 0; i < _imageGestures.length; i++) {
                    var gesture = _imageGestures[i];
                    _dollar.AddGesture(gesture.name, gesture.ptArray);
                }
            }

            (function () {
            
                $(function() {

                    $.Mustache.addFromDom();
                    adq.imagebrowser.init({});

                    _points = new Array();
                    _dollar = new PDollarRecognizer();

                    var canvas = $('#myCanvas')[0];
                    _ctx = canvas.getContext('2d');
                    _ctx.fillStyle = "rgb(0,0,225)";
                    _ctx.strokeStyle = "rgb(0,0,225)";
                    _ctx.lineWidth = 3;
                    _ctx.font = "16px Gentilis";
                    _canvasRect = getCanvasRect(canvas);

                    _isMouseDown = false;

                    canvas.addEventListener("mousedown", function(evt) {
                        mouseDownEvent(evt.clientX, evt.clientY);
                    }, false);

                    canvas.addEventListener("mousemove", function(evt) {
                        mouseMoveEvent(evt.clientX, evt.clientY);
                    }, false);

                    canvas.addEventListener("mouseup", function(evt) {
                        mouseUpEvent(evt.clientX, evt.clientY);
                    }, false);

                    addImageGestures();

                    $('#myCarousel').carousel({
                      interval: false
                    });

                    $('.thumbnail img').live('click', function() {
                        _ctx.drawImage(this, 0, 0, _canvasRect.width, _canvasRect.height);
                    });

                });

                $(window).load(function() {
                    //replaceCanvas($('#image-baby'));
                });
            
            })();

        </script>
    </head>

    <body>
        <div class="container">
            <div class="navbar navbar-inverse">
                <div class="navbar-inner">
                    <ul class="nav nav-pills">
                        <a class="brand" href="#home-pane" data-toggle="tab">Title Home</a>
                        <li><a href="#messages-pane" data-toggle="tab">Msgs</a></li>
                        <li><a href="#settings-pane" data-toggle="tab">Stngs</a></li>
                    </ul>
                </div>
            </div>
            <div class="tab-content">
                <div class="tab-pane active" id="home-pane">Home stuff</div>
                <div class="tab-pane" id="messages-pane">msgs stuff</div>
                <div class="tab-pane" id="settings-pane">settings stuff</div>
            </div>
        </div>

        <div class="container">
            <input type="file"/>
            <div class="pull-right">
                <a href="#modal-help" data-toggle="modal">Help</a>
            </div>
            <div id="alertContainer">Image Browser</div>
            <canvas id="myCanvas" width="540" height="405" oncontextmenu="return false;"></canvas>
            <div class="row" style="padding-top:20px;">
                <div class="span1"></div>
                <div class="carousel slide span10" id="myCarousel">
                    <div class="carousel-inner">
                        <div class="item active">
                            <ul class="thumbnails">
                                <li class="span1"></li>
                                <li class="span2">
                                    <div class="thumbnail">
                                        <img src="images/Baby.jpg" alt="">
                                    </div>
                                </li>
                                <li class="span2">
                                    <div class="thumbnail">
                                        <img src="images/Canoe.jpg" alt="">
                                    </div>
                                </li>
                                <li class="span2">
                                    <div class="thumbnail">
                                        <img src="images/Cat.jpg" alt="">
                                    </div>
                                </li>
                                <li class="span2">
                                    <div class="thumbnail">
                                        <img src="images/Highway.jpg" alt="">
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="item">
                            <ul class="thumbnails">
                                <li class="span1"></li>
                                <li class="span2">
                                    <div class="thumbnail">
                                        <img src="images/Leopard.jpg" alt="">
                                    </div>
                                </li>
                                <li class="span2">
                                    <div class="thumbnail">
                                        <img src="images/Mountain.jpg" alt="">
                                    </div>
                                </li>
                                <li class="span2">
                                    <div class="thumbnail">
                                        <img src="images/Soccer.jpg" alt="">
                                    </div>
                                </li>
                                <li class="span2">
                                    <div class="thumbnail">
                                        <img src="images/Persia.jpg" alt="">
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="item">
                            <ul class="thumbnails">
                                <li class="span1"></li>
                                <li class="span2">
                                    <div class="thumbnail">
                                        <img src="images/Pixar.jpg" alt="">
                                    </div>
                                </li>
                                <li class="span2">
                                    <div class="thumbnail">
                                        <img src="images/Wolf.jpg" alt="">
                                    </div>
                                </li>
                                <li class="span2">
                                    <div class="thumbnail">
                                        <img src="images/Hotel.jpg" alt="">
                                    </div>
                                </li>
                                <li class="span2">
                                    <div class="thumbnail">
                                        <img src="images/Man.jpg" alt="">
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <a data-slide="prev" href="#myCarousel" class="left carousel-control">‹</a>
                    <a data-slide="next" href="#myCarousel" class="right carousel-control">›</a>
                </div>
            </div>
        </div>

        <div id="images">
            <img alt="" src="images/Baby.jpg" id="image-baby" />
            <img alt="" src="images/Canoe.jpg" id="image-canoe" />
            <img alt="" src="images/Cat.jpg" id="image-cat" />
            <img alt="" src="images/Highway.jpg" id="image-highway" />
            <img alt="" src="images/Leopard.jpg" id="image-leopard" />
            <img alt="" src="images/Mountain.jpg" id="image-mountain" />
            <img alt="" src="images/Persia.jpg" id="image-persia" />
            <img alt="" src="images/Soccer.jpg" id="image-soccer" />
            <img alt="" src="images/Hotel.jpg" id="image-hotel" />
            <img alt="" src="images/Wolf.jpg" id="image-wolf" />
        </div>

        <div class="modal hide fade" id="modal-help">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h3>Help</h3>
            </div>
            <div class="modal-body">
                <h4>Browsing</h4>
                <p>Some stuff</p>
                <h4>Editing</h4>
                <p>Some stuff</p>
                <h4>Uploading</h4>
                <p>Some stuff</p>
            </div>
        </div>

    </body>

</html>

<!-- mustache templates -->

<script id="alert" type="text/html">
    <div class="alert alert-error fade in">
        <button type="button" class="close" data-dismiss="alert">×</button>
        <strong>Oops!</strong> {{message}}
    </div>
</script>